<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  >
  <title>Countdown Service</title>
  <!-- OG Metadata for social media sharing -->
  <meta
    property="og:title"
    content="Countdown Service"
  >
  <meta
    property="og:description"
    content="A customizable countdown timer with full-screen mode, sound effects, and confetti."
  >
  <meta
    property="og:image"
    content="https://countdown-cni.pages.dev/og.jpg"
  >
  <meta
    property="og:url"
    content="https://countdown-cni.pages.dev"
  >
  <meta
    property="og:type"
    content="website"
  >

  <!-- Twitter Card Metadata -->
  <meta
    name="twitter:card"
    content="summary_large_image"
  >
  <meta
    name="twitter:title"
    content="Countdown Service"
  >
  <meta
    name="twitter:description"
    content="A customizable countdown timer with full-screen mode, sound effects, and confetti."
  >
  <meta
    name="twitter:image"
    content="https://placehold.co/1200x630/00bcd4/ffffff?text=Countdown+Service"
  >

  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for fullscreen icon -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  >
  <!-- Google Fonts for Seven-Segment style numbers -->
  <link
    rel="preconnect"
    href="https://fonts.googleapis.com"
  >
  <link
    rel="preconnect"
    href="https://fonts.gstatic.com"
    crossorigin
  >
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap"
    rel="stylesheet"
  >
  <style>
    /* Main styling for the entire screen */
    body {
      font-family: 'Orbitron', sans-serif;
      background-size: cover;
      background-position: center;
      transition: background-image 0.5s ease-in-out;
      background-color: #1a202c;
      /* Default dark background */
    }

    /* Add an overlay to make text more readable on the background */
    #background-overlay {
      background-color: rgba(0, 0, 0, 0.6);
    }

    /* Dynamic styling for countdown numbers based on screen size */
    .countdown-number {
      font-size: clamp(4rem, 15vw, 15rem);
      /* Adjusts size to be as large as possible */
      text-shadow: 0 0 20px #00FFFF, 0 0 30px #00FFFF, 0 0 40px #00FFFF;
      /* Glow effect */
      line-height: 1;
      /* Adjust line-height for better fit */
    }

    .countdown-label {
      font-size: clamp(1rem, 3vw, 2rem);
      /* Dynamic label size */
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Animation for the red glowing/blinking effect */
    @keyframes red-glow-blink {
      50% {
        text-shadow: 0 0 20px #ff3333, 0 0 30px #ff3333, 0 0 40px #ff3333;
      }
    }

    .warning-glow {
      animation: red-glow-blink 1s infinite;
    }

    /* CSS for the confetti effect */
    .confetti-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 20;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f0f;
      animation: confetti-fall 3s forwards;
      opacity: 0;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
  </style>
</head>

<body
  class="bg-gradient-to-br from-indigo-900 to-purple-900 text-white min-h-screen flex items-center justify-center p-4"
>

  <!-- Full-screen overlay -->
  <div
    id="background-overlay"
    class="absolute inset-0 z-0 flex items-center justify-center"
  >

    <!-- Countdown and real-time clock display -->
    <div
      id="countdown-panel"
      class="text-center z-10 w-full"
    >
      <div
        id="checkpoint-name-display"
        class="text-2xl md:text-4xl font-bold mb-4 h-10"
      ></div>
      <div
        id="timer-display"
        class="flex flex-wrap justify-center items-center gap-4 md:gap-8"
      >
        <!-- Hours -->
        <div
          id="hours-container"
          class="flex flex-col items-center p-4"
        >
          <span
            id="hours"
            class="countdown-number font-bold"
          >00</span>
          <span class="countdown-label">Hours</span>
        </div>

        <!-- Minutes -->
        <div class="flex flex-col items-center p-4">
          <span
            id="minutes"
            class="countdown-number font-bold"
          >00</span>
          <span class="countdown-label">Minutes</span>
        </div>

        <!-- Seconds -->
        <div class="flex flex-col items-center p-4">
          <span
            id="seconds"
            class="countdown-number font-bold"
          >00</span>
          <span class="countdown-label">Seconds</span>
        </div>
      </div>

      <!-- End of countdown message and button -->
      <div
        id="finished-message-panel"
        class="hidden flex flex-col items-center mt-8"
      >
        <div
          id="final-message"
          class="text-3xl md:text-5xl font-bold mb-4"
        >
          END!!
        </div>
        <button
          id="restart-button"
          class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-colors"
        >
          Restart
        </button>
      </div>

      <!-- Configuration section (shown when not counting down) -->
      <div
        id="config-panel"
        class="mt-8"
      >
        <div class="bg-white/10 p-4 md:p-6 rounded-xl shadow-xl backdrop-blur-sm w-full max-w-2xl mx-auto">
          <!-- Basic Inputs -->
          <div id="basic-inputs">
            <div class="flex items-center justify-center gap-2 mb-4">
              <input
                type="number"
                id="countdown-hours"
                min="0"
                value="0"
                class="w-20 p-2 rounded-lg text-center text-black bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <span class="text-sm font-bold">Hours</span>
              <input
                type="number"
                id="countdown-minutes"
                min="0"
                max="59"
                value="0"
                class="w-20 p-2 rounded-lg text-center text-black bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <span class="text-sm font-bold">Minutes</span>
              <input
                type="number"
                id="countdown-seconds"
                min="0"
                max="59"
                value="0"
                class="w-20 p-2 rounded-lg text-center text-black bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
              <span class="text-sm font-bold">Seconds</span>
            </div>
          </div>

          <!-- Background image selection -->
          <div class="mb-4">
            <label
              for="background-image"
              class="block text-sm mb-2"
            >Choose Background Image</label>
            <input
              type="file"
              id="background-image"
              accept="image/*"
              class="w-full text-sm text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
          </div>

          <!-- Input for the end-of-countdown message -->
          <div class="mb-4">
            <label
              for="final-text-input"
              class="block text-sm mb-2"
            >Message to display at the end (default is "END!!")</label>
            <input
              type="text"
              id="final-text-input"
              placeholder="END!!"
              value="END!!"
              class="w-full p-2 rounded-lg text-black bg-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500"
            >
          </div>

          <!-- Advanced Settings -->
          <div class="mb-4">
            <button
              id="advanced-toggle-button"
              class="text-blue-300 hover:text-blue-200"
            >Advanced Settings</button>
          </div>
          <div
            id="advanced-config-panel"
            class="hidden border-t border-white/20 pt-4"
          >
            <h3 class="text-lg font-bold mb-2">Checkpoints</h3>
            <div
              id="checkpoints-list"
              class="space-y-2 max-h-40 overflow-y-auto pr-2"
            >
              <!-- Checkpoint rows will be injected here -->
            </div>
            <div class="flex justify-between items-center mt-4">
              <button
                id="add-checkpoint-button"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm"
              >
                <i class="fas fa-plus"></i> Add Checkpoint
              </button>
              <button
                id="reset-checkpoints-button"
                class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg text-sm"
              >
                <i class="fas fa-undo"></i> Reset All
              </button>
            </div>
            <div class="flex justify-between items-center mt-4 border-t border-white/20 pt-4">
              <div>
                <label
                  for="warning-time"
                  class="text-sm mr-2"
                >Warning Time:</label>
                <input
                  type="number"
                  id="warning-minutes"
                  min="0"
                  max="59"
                  value="0"
                  class="w-14 p-1 rounded-lg text-center text-sm text-black bg-gray-200"
                >m
                <input
                  type="number"
                  id="warning-seconds"
                  min="0"
                  max="59"
                  value="10"
                  class="w-14 p-1 rounded-lg text-center text-sm text-black bg-gray-200"
                >s
              </div>
              <button
                id="exit-advanced-button"
                class="text-blue-300 hover:text-blue-200 text-sm"
              >Back to Basic</button>
            </div>
          </div>

          <button
            id="start-button"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-colors mt-6"
          >
            Start Countdown
          </button>
        </div>
      </div>

      <!-- Container for action buttons during countdown -->
      <div
        id="countdown-actions"
        class="mt-4 flex justify-center items-center gap-4 hidden"
      >
        <button
          id="reset-button"
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-colors"
        >
          Stop Countdown
        </button>
        <button
          id="change-background-button"
          class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-3 rounded-full shadow-lg transition-colors"
          title="Change Background"
        >
          <i class="fas fa-camera"></i>
        </button>
      </div>
    </div>

    <!-- Fullscreen Toggle Button -->
    <button
      id="fullscreen-button"
      class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors hidden"
    >
      <i class="fa-solid fa-expand"></i>
    </button>
  </div>

  <!-- Audio element for the beep sound -->
  <audio
    id="beep-sound"
    preload="auto"
  >
    <!-- Using a base64 encoded audio file for a simple beep -->
    <source
      src="data:audio/wav;base64,UklGRl9QDQBXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YSAXAAAAAQAAAQIAAQADAAIAAgACAAEAAAABAAIAAgACAAEAAAABAAEAAQAA"
      type="audio/wav"
    >
  </audio>

  <script>
    // DOM Elements
    const body = document.body
    const configPanel = document.getElementById('config-panel')
    const countdownPanel = document.getElementById('countdown-panel')
    const finishedMessagePanel = document.getElementById('finished-message-panel')
    const timerDisplay = document.getElementById('timer-display')
    const countdownHoursInput = document.getElementById('countdown-hours')
    const countdownMinutesInput = document.getElementById('countdown-minutes')
    const countdownSecondsInput = document.getElementById('countdown-seconds')
    const startButton = document.getElementById('start-button')
    const resetButton = document.getElementById('reset-button')
    const restartButton = document.getElementById('restart-button')
    const backgroundImageInput = document.getElementById('background-image')
    const finalTextInput = document.getElementById('final-text-input')
    const finalMessageElement = document.getElementById('final-message')
    const fullscreenButton = document.getElementById('fullscreen-button')
    const countdownActions = document.getElementById('countdown-actions')
    const changeBackgroundButton = document.getElementById('change-background-button')
    const hoursContainer = document.getElementById('hours-container')
    const checkpointNameDisplay = document.getElementById('checkpoint-name-display')

    // Advanced / Checkpoint Elements
    const advancedToggleButton = document.getElementById('advanced-toggle-button')
    const advancedConfigPanel = document.getElementById('advanced-config-panel')
    const checkpointsList = document.getElementById('checkpoints-list')
    const addCheckpointButton = document.getElementById('add-checkpoint-button')
    const resetCheckpointsButton = document.getElementById('reset-checkpoints-button')
    const exitAdvancedButton = document.getElementById('exit-advanced-button')
    const basicInputs = document.getElementById('basic-inputs')
    const warningMinutesInput = document.getElementById('warning-minutes')
    const warningSecondsInput = document.getElementById('warning-seconds')


    const hoursElement = document.getElementById('hours')
    const minutesElement = document.getElementById('minutes')
    const secondsElement = document.getElementById('seconds')
    const beepSound = document.getElementById('beep-sound')

    let realTimeClockInterval
    let countdownInterval
    let hasInteracted = false // Flag to check for user interaction

    // Function to pad a number with a leading zero
    function pad (number) {
      return number < 10 ? '0' + String(number) : String(number)
    }

    // --- Checkpoint Functions ---
    function addCheckpointRow (checkpoint = { id: Date.now(), name: '', h: 0, m: 0, s: 0 }) {
      const row = document.createElement('div')
      row.className = 'flex items-center gap-2 checkpoint-row'
      row.dataset.id = checkpoint.id

      row.innerHTML = `
                <input type="text" placeholder="Checkpoint Name" value="${checkpoint.name}" class="checkpoint-name flex-grow p-1 rounded-lg text-sm text-black bg-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <input type="number" min="0" value="${checkpoint.h}" class="checkpoint-h w-14 p-1 rounded-lg text-center text-sm text-black bg-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500">h
                <input type="number" min="0" max="59" value="${checkpoint.m}" class="checkpoint-m w-14 p-1 rounded-lg text-center text-sm text-black bg-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500">m
                <input type="number" min="0" max="59" value="${checkpoint.s}" class="checkpoint-s w-14 p-1 rounded-lg text-center text-sm text-black bg-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500">s
                <button class="remove-checkpoint-button bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">&times;</button>
            `
      checkpointsList.appendChild(row)

      row.querySelector('.remove-checkpoint-button').addEventListener('click', () => {
        row.remove()
      })
    }

    function getCheckpointsFromUI () {
      const rows = checkpointsList.querySelectorAll('.checkpoint-row')
      const checkpoints = []
      rows.forEach(row => {
        const name = row.querySelector('.checkpoint-name').value || 'Checkpoint'
        const h = parseInt(row.querySelector('.checkpoint-h').value) || 0
        const m = parseInt(row.querySelector('.checkpoint-m').value) || 0
        const s = parseInt(row.querySelector('.checkpoint-s').value) || 0
        const duration = (h * 3600 + m * 60 + s) * 1000
        if (duration > 0) {
          checkpoints.push({ name, duration })
        }
      })
      return checkpoints
    }


    // --- Local Storage Functions ---
    function saveToLocalStorage (data) {
      Object.keys(data).forEach(key => {
        try {
          // Handle null/undefined backgroundData specifically
          if (key === 'backgroundData' && !data[key]) {
            localStorage.removeItem('backgroundData')
            return // continue to next key in forEach
          }
          localStorage.setItem(key, JSON.stringify(data[key]))
        } catch (e) {
          // If saving fails, check if it's the background image and a QuotaExceededError
          if (key === 'backgroundData' && e.name === 'QuotaExceededError') {
            console.warn('The selected background image is too large to be saved for the next session. It will not be available on page reload.')
            // Ensure any previous large image is also removed to prevent blocking other saves
            localStorage.removeItem('backgroundData')
          } else {
            // For other errors or other keys, we might still want to know
            console.error(`Failed to save key "${key}" to localStorage:`, e)
          }
        }
      })
    }

    function loadFromLocalStorage () {
      const targetTimestamp = JSON.parse(localStorage.getItem('countdownTarget'))
      const backgroundData = JSON.parse(localStorage.getItem('backgroundData'))
      const finalText = JSON.parse(localStorage.getItem('finalText')) || 'END!!'
      const checkpoints = JSON.parse(localStorage.getItem('checkpoints'))
      const checkpointEndTimes = JSON.parse(localStorage.getItem('checkpointEndTimes'))
      const warningTime = JSON.parse(localStorage.getItem('warningTime'))
      return { targetTimestamp, backgroundData, finalText, checkpoints, checkpointEndTimes, warningTime }
    }

    function clearLocalStorage () {
      localStorage.removeItem('countdownTarget')
      localStorage.removeItem('backgroundData')
      localStorage.removeItem('finalText')
      localStorage.removeItem('checkpoints')
      localStorage.removeItem('checkpointEndTimes')
      localStorage.removeItem('warningTime')
    }

    // --- UI State Functions ---
    function showConfigState () {
      configPanel.classList.remove('hidden')
      countdownActions.classList.add('hidden')
      finishedMessagePanel.classList.add('hidden')
      fullscreenButton.classList.add('hidden');

      // Clear any active warning glows
      [hoursElement, minutesElement, secondsElement, checkpointNameDisplay].forEach(el => el.classList.remove('warning-glow'))
      checkpointNameDisplay.textContent = ''
      hoursContainer.classList.remove('hidden')
    }

    function showCountdownState () {
      configPanel.classList.add('hidden')
      countdownActions.classList.remove('hidden')
      fullscreenButton.classList.remove('hidden')
    }

    // --- Effects ---
    function createConfetti () {
      const confettiContainer = document.createElement('div')
      confettiContainer.className = 'confetti-container'
      document.body.appendChild(confettiContainer)
      const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548', '#607d8b']

      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div')
        confetti.className = 'confetti'
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]
        confetti.style.width = Math.random() * 10 + 5 + 'px'
        confetti.style.height = confetti.style.width
        confetti.style.left = Math.random() * 100 + 'vw'
        confetti.style.animationDelay = Math.random() * 2 + 's'
        confetti.style.animationDuration = Math.random() * 2 + 3 + 's'
        confettiContainer.appendChild(confetti)
      }

      setTimeout(() => confettiContainer.remove(), 5000)
    }

    function playBeepSound () {
      if (hasInteracted) {
        beepSound.currentTime = 0
        beepSound.play().catch(e => console.error("Audio playback failed:", e))
      }
    }

    // --- Core Countdown Logic ---
    function startRealTimeClock () {
      clearInterval(countdownInterval)
      showConfigState()
      realTimeClockInterval = setInterval(() => {
        const now = new Date()
        hoursElement.textContent = pad(now.getHours())
        minutesElement.textContent = pad(now.getMinutes())
        secondsElement.textContent = pad(now.getSeconds())
      }, 1000)
    }

    function updateDisplayFromInput () {
      clearInterval(realTimeClockInterval)
      const hours = parseInt(countdownHoursInput.value) || 0
      const minutes = parseInt(countdownMinutesInput.value) || 0
      const seconds = parseInt(countdownSecondsInput.value) || 0
      hoursElement.textContent = pad(hours)
      minutesElement.textContent = pad(minutes)
      secondsElement.textContent = pad(seconds)
    }

    function startCountdown ({ targetTimestamp, backgroundData, finalText, checkpoints, checkpointEndTimes, showHours, warningTimeMs }) {
      clearInterval(realTimeClockInterval)
      showCountdownState()
      hoursContainer.classList.toggle('hidden', !showHours)

      if (backgroundData) {
        body.style.backgroundImage = `url(${backgroundData})`
      }

      countdownInterval = setInterval(() => {
        const now = new Date().getTime()
        const overallDistance = targetTimestamp - now

        if (overallDistance < 0) {
          clearInterval(countdownInterval);
          [hoursElement, minutesElement, secondsElement, checkpointNameDisplay].forEach(el => el.classList.remove('warning-glow'))
          beepSound.pause()
          createConfetti()

          hoursContainer.classList.remove('hidden')
          timerDisplay.classList.remove('hidden')
          hoursElement.textContent = '00'
          minutesElement.textContent = '00'
          secondsElement.textContent = '00'
          finalMessageElement.textContent = finalText || 'END!!'
          finishedMessagePanel.classList.remove('hidden')
          countdownActions.classList.add('hidden')
          fullscreenButton.classList.add('hidden')
          checkpointNameDisplay.textContent = ''
          clearLocalStorage()
          return
        }


        let currentCheckpointIndex = checkpointEndTimes.findIndex(endTime => now < endTime)

        if (currentCheckpointIndex !== -1) {
          let currentCheckpoint = checkpoints[currentCheckpointIndex]
          let checkpointDistance = checkpointEndTimes[currentCheckpointIndex] - now

          checkpointNameDisplay.textContent = currentCheckpoint.name

          if (checkpointDistance <= warningTimeMs) {
            [hoursElement, minutesElement, secondsElement, checkpointNameDisplay].forEach(el => el.classList.add('warning-glow'))
            playBeepSound()
          } else {
            [hoursElement, minutesElement, secondsElement, checkpointNameDisplay].forEach(el => el.classList.remove('warning-glow'))
          }
        } else {
          checkpointNameDisplay.textContent = '';
          [hoursElement, minutesElement, secondsElement, checkpointNameDisplay].forEach(el => el.classList.remove('warning-glow'))
        }

        // Display logic for the main timer numbers
        if (showHours) {
          hoursElement.textContent = pad(Math.floor(overallDistance / (1000 * 60 * 60)))
          minutesElement.textContent = pad(Math.floor((overallDistance % (1000 * 60 * 60)) / (1000 * 60)))
          secondsElement.textContent = pad(Math.floor((overallDistance % (1000 * 60)) / 1000))
        } else {
          minutesElement.textContent = pad(Math.floor(overallDistance / (1000 * 60)))
          secondsElement.textContent = pad(Math.floor((overallDistance % (1000 * 60)) / 1000))
        }

      }, 1000)
    }

    function toggleFullscreen () {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`)
        })
      } else if (document.exitFullscreen) {
        document.exitFullscreen()
      }
    }

    // --- Event Listeners ---
    function toggleAdvancedMode (showAdvanced) {
      advancedConfigPanel.classList.toggle('hidden', !showAdvanced)
      basicInputs.classList.toggle('hidden', showAdvanced)
    }

    advancedToggleButton.addEventListener('click', () => toggleAdvancedMode(true))
    exitAdvancedButton.addEventListener('click', () => toggleAdvancedMode(false))

    addCheckpointButton.addEventListener('click', () => addCheckpointRow())

    resetCheckpointsButton.addEventListener('click', () => {
      if (confirm('Are you sure you want to reset all checkpoints?')) {
        checkpointsList.innerHTML = ''
      }
    })

    startButton.addEventListener('click', () => {
      hasInteracted = true
      let checkpoints = []
      const isInAdvancedMode = !advancedConfigPanel.classList.contains('hidden')

      if (isInAdvancedMode) {
        checkpoints = getCheckpointsFromUI()
        if (checkpoints.length === 0) {
          alert('Please add at least one checkpoint in Advanced Mode, or switch back to Basic Mode.')
          return
        }
      } else {
        const h = parseInt(countdownHoursInput.value) || 0
        const m = parseInt(countdownMinutesInput.value) || 0
        const s = parseInt(countdownSecondsInput.value) || 0
        const duration = (h * 3600 + m * 60 + s) * 1000
        if (duration <= 0) {
          alert('Please set a duration.')
          return
        }
        checkpoints.push({ name: '', duration })
      }

      const totalDuration = checkpoints.reduce((acc, cp) => acc + cp.duration, 0)
      const targetTimestamp = new Date().getTime() + totalDuration

      let accumulatedTime = 0
      const checkpointEndTimes = checkpoints.map(cp => {
        accumulatedTime += cp.duration
        return targetTimestamp - totalDuration + accumulatedTime
      })

      const file = backgroundImageInput.files[0]
      const finalText = finalTextInput.value || 'END!!'
      const showHours = totalDuration >= 3600000
      const warningM = parseInt(warningMinutesInput.value) || 0
      const warningS = parseInt(warningSecondsInput.value) || 0
      const warningTimeMs = (warningM * 60 + warningS) * 1000

      const startData = { targetTimestamp, finalText, checkpoints, checkpointEndTimes, showHours, warningTimeMs }
      const storageData = { ...startData, warningTime: { m: warningM, s: warningS } }
      delete storageData.warningTimeMs // Don't need to store this calculated value

      if (file) {
        const reader = new FileReader()
        reader.onload = (e) => {
          startData.backgroundData = e.target.result
          storageData.backgroundData = e.target.result
          saveToLocalStorage(storageData)
          startCountdown(startData)
        }
        reader.readAsDataURL(file)
      } else {
        startData.backgroundData = JSON.parse(localStorage.getItem('backgroundData'))
        storageData.backgroundData = startData.backgroundData
        saveToLocalStorage(storageData)
        startCountdown(startData)
      }
    })

    backgroundImageInput.addEventListener('change', () => {
      const file = backgroundImageInput.files[0]
      if (file) {
        const reader = new FileReader()
        reader.onload = (e) => {
          const backgroundData = e.target.result
          body.style.backgroundImage = `url(${backgroundData})`
          // Use the robust save function to handle potential quota errors
          saveToLocalStorage({ backgroundData: backgroundData })
        }
        reader.readAsDataURL(file)
      }
    })

    resetButton.addEventListener('click', () => {
      clearInterval(countdownInterval)
      beepSound.pause()
      beepSound.currentTime = 0
      clearLocalStorage()
      body.style.backgroundImage = ''
      startRealTimeClock()
    })

    restartButton.addEventListener('click', startRealTimeClock)
    changeBackgroundButton.addEventListener('click', () => backgroundImageInput.click())
    fullscreenButton.addEventListener('click', toggleFullscreen)
    countdownHoursInput.addEventListener('input', updateDisplayFromInput)
    countdownMinutesInput.addEventListener('input', updateDisplayFromInput)
    countdownSecondsInput.addEventListener('input', updateDisplayFromInput)
    finalTextInput.addEventListener('input', () => {
      saveToLocalStorage({ finalText: finalTextInput.value })
    })

    document.addEventListener('mousedown', () => { hasInteracted = true }, { once: true })
    document.addEventListener('keydown', () => { hasInteracted = true }, { once: true })

    // --- On Load ---
    window.addEventListener('load', () => {
      const data = loadFromLocalStorage()

      if (data.backgroundData) {
        body.style.backgroundImage = `url(${data.backgroundData})`
      }

      finalTextInput.value = data.finalText

      if (data.warningTime) {
        warningMinutesInput.value = data.warningTime.m
        warningSecondsInput.value = data.warningTime.s
      }

      if (data.checkpoints) {
        checkpointsList.innerHTML = ''
        data.checkpoints.forEach((cp, index) => {
          const checkpointWithId = { ...cp, id: Date.now() + index, h: Math.floor(cp.duration / 3600000), m: Math.floor((cp.duration % 3600000) / 60000), s: Math.floor((cp.duration % 60000) / 1000) }
          addCheckpointRow(checkpointWithId)
        })
        if (data.checkpoints.length > 0) {
          toggleAdvancedMode(true)
        }
      }

      if (data.targetTimestamp && data.targetTimestamp > new Date().getTime()) {
        hasInteracted = true
        const totalDuration = data.checkpoints ? data.checkpoints.reduce((acc, cp) => acc + cp.duration, 0) : (data.targetTimestamp - new Date().getTime())
        data.showHours = totalDuration >= 3600000
        const warningM = data.warningTime ? data.warningTime.m : 0
        const warningS = data.warningTime ? data.warningTime.s : 10
        data.warningTimeMs = (warningM * 60 + warningS) * 1000
        startCountdown(data)
      } else {
        clearLocalStorage() // Clear any expired countdown data
        startRealTimeClock()
      }
    });
  </script>
</body>

</html>